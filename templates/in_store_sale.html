{% extends "base.html" %}

{% block title %}In-Store Sale{% endblock %}

{% block styles %}
<!-- Add custom styles for the notification animation -->
<style>
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(255, 193, 7, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }
    
    .animate-pulse {
        animation: pulse 1s infinite;
    }
    
    #onlineOrdersAlert.show {
        display: flex !important;
        align-items: center;
        font-weight: bold;
        font-size: 1.1em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Online Orders Alert -->
    <div id="onlineOrdersAlert" class="alert alert-danger alert-dismissible fade d-none" role="alert" style="font-size: 1.2em; font-weight: bold; border: 2px solid red;">
        <i class="fas fa-bell me-2"></i>
        <strong>New Online Orders!</strong> <span id="onlineOrderCount">0</span> order(s) waiting to be processed.
        <button type="button" class="btn btn-sm btn-primary ms-3" data-bs-toggle="modal" data-bs-target="#onlineOrdersModal">
            View Orders
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <div class="row mb-3">
        <div class="col">
            <h2>Create In-Store Sale</h2>
        </div>
    </div>
    
    <form method="POST" action="{{ url_for('in_store_sale') }}" id="saleForm">
        <!-- First row: Customer Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" id="customerInfoCard">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Customer Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="customer_name" class="form-label">Customer Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" placeholder="Walk-in Customer" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="customer_phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="customer_email" class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="customer_address" class="form-label">Address (Optional)</label>
                                <textarea class="form-control" id="customer_address" name="customer_address" rows="1"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Second row: Products and Order Summary side by side -->
        <div class="row mb-4">
            <!-- Products section (left side) -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Products</h5>
                            <div class="input-group" style="width: 300px;">
                                <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row row-cols-1 row-cols-md-3 g-3">
                            {% for product in products %}
                            <div class="col product-item" data-name="{{ product.name|lower }}" data-category="{{ product.category|lower if product.category else '' }}">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ product.name }}</h6>
                                        <p class="card-text">
                                            <small class="text-muted">{{ product.category }}</small><br>
                                            <strong>Price: {{ "%.2f"|format(product.price) }} UGX</strong><br>
                                            <small>In Stock: <span class="product-stock" data-product-id="{{ product.id }}">{{ "%.2f"|format(product.stock) }}</span> {{ product.unit }}</small>
                                        </p>
                                        <div class="input-group mt-2">
                                            <span class="input-group-text">Qty</span>
                                            <input type="number" class="form-control" min="0" max="{{ product.stock }}" 
                                                   name="quantity-{{ product.id }}" 
                                                   id="quantity-{{ product.id }}" 
                                                   value="0"
                                                   data-product-id="{{ product.id }}"
                                                   data-product-name="{{ product.name }}"
                                                   data-product-price="{{ product.price }}"
                                                   data-product-stock="{{ product.stock }}"
                                                   onchange="updateOrderSummary(this)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary section (right side) -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <table class="table" id="orderSummary">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Order items will be added dynamically -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                                    <td><strong id="grandTotal">0.00 UGX</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary" id="completeSaleBtn" disabled>Complete Sale</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Customer Information Modal -->
<div class="modal fade" id="customerInfoModal" tabindex="-1" aria-labelledby="customerInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerInfoModalLabel">Enter Customer Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please enter customer information to proceed with the order.</p>
                <div class="mb-3">
                    <label for="modal_customer_name" class="form-label">Customer Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="modal_customer_name">
                </div>
                <div class="mb-3">
                    <label for="modal_customer_phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="modal_customer_phone">
                </div>
                <div class="mb-3">
                    <label for="modal_customer_email" class="form-label">Email (Optional)</label>
                    <input type="email" class="form-control" id="modal_customer_email">
                </div>
                <div class="mb-3">
                    <label for="modal_customer_address" class="form-label">Address (Optional)</label>
                    <textarea class="form-control" id="modal_customer_address" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomerInfo()">Save and Continue</button>
            </div>
        </div>
    </div>
</div>

<!-- Online Orders Modal -->
<div class="modal fade" id="onlineOrdersModal" tabindex="-1" aria-labelledby="onlineOrdersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="onlineOrdersModalLabel">Pending Online Orders</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="onlineOrdersTable">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Address</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders will be added dynamically -->
                        </tbody>
                    </table>
                    <!-- No orders message -->
                    <div id="noOrdersMessage" class="alert alert-info text-center d-none">
                        <i class="fas fa-info-circle me-2"></i> No pending online orders at this time.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="refreshOrdersBtn" onclick="refreshOrders()">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Make sure app.js is loaded before in_store_sale.js -->
<script src="{{ url_for('static', filename='js/app.js') }}?v={{ version }}&t={{ timestamp }}"></script>
<script src="{{ url_for('static', filename='js/in_store_sale.js') }}?v={{ version }}&t={{ timestamp }}"></script>
<script>
    // Check for pending online orders
    let lastOrderCount = 0;
    // Sound notification disabled per user request - visual alerts only
    
    // Display visual notification for new online orders
    function showOrderNotification() {
        try {
            // Make the notification flash by adding a pulse animation
            const alert = document.getElementById('onlineOrdersAlert');
            alert.classList.add('animate-pulse');
            setTimeout(() => {
                alert.classList.remove('animate-pulse');
            }, 3000);
        } catch(e) {
            console.error("Error during notification:", e);
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Refresh stock information immediately
        if (typeof window.refreshStock === 'function') {
            console.log('Initial stock refresh for in-store sale page...');
            window.refreshStock();
        } else {
            console.error('refreshStock function not found, it should be defined in app.js');
        }
        
        // Set up periodic stock refresh every 10 seconds
        setInterval(function() {
            if (typeof window.refreshStock === 'function') {
                console.log('Auto-refreshing stock information...');
                window.refreshStock();
            } else {
                console.error('refreshStock function not found during auto-refresh');
            }
        }, 10000);
        
        // Initial check for pending orders
        console.log("Performing initial check for pending orders...");
        checkOnlineOrders();
        
        // Manually check if there are pending orders right now
        fetch('/api/pending_orders')
            .then(response => response.json())
            .then(data => {
                console.log("Initial order check:", data);
                if (data.pending_orders && data.pending_orders.length > 0) {
                    console.log("Found " + data.pending_orders.length + " pending orders on load, showing alert");
                    // Force the alert to show immediately
                    const alertElement = document.getElementById('onlineOrdersAlert');
                    alertElement.classList.add('show');
                    alertElement.classList.remove('d-none');
                    // Update counter
                    document.getElementById('onlineOrderCount').textContent = data.pending_orders.length;
                    // Set lastOrderCount
                    lastOrderCount = data.pending_orders.length;
                }
            })
            .catch(error => {
                console.error("Error checking initial orders:", error);
            });
        
        // Check for new orders more frequently (every 20 seconds) for better responsiveness
        setInterval(checkOnlineOrders, 20000);
        
        // Check if we should auto-open the orders modal based on URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('openOrdersModal') === 'true') {
            setTimeout(() => {
                const orderModal = new bootstrap.Modal(document.getElementById('onlineOrdersModal'));
                orderModal.show();
            }, 500); // Small delay to ensure page is ready
        }
        
        // Prefill modal fields when shown
        document.getElementById('customerInfoModal').addEventListener('show.bs.modal', function() {
            document.getElementById('modal_customer_name').value = document.getElementById('customer_name').value;
            document.getElementById('modal_customer_phone').value = document.getElementById('customer_phone').value;
            document.getElementById('modal_customer_email').value = document.getElementById('customer_email').value;
            document.getElementById('modal_customer_address').value = document.getElementById('customer_address').value;
        });
    });
    
    // Product search functionality
    document.getElementById('productSearch').addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        const productItems = document.querySelectorAll('.product-item');
        
        productItems.forEach(item => {
            const productName = item.dataset.name;
            const productCategory = item.dataset.category;
            
            if (productName.includes(searchTerm) || productCategory.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Update order summary when quantity changes
    function updateOrderSummary(input) {
        const quantity = parseInt(input.value) || 0;
        const productId = input.dataset.productId;
        const productName = input.dataset.productName;
        const productPrice = parseFloat(input.dataset.productPrice);
        const productStock = parseFloat(input.dataset.productStock);
        
        // Validate quantity against stock
        if (quantity > productStock) {
            alert(`Only ${productStock} units available for ${productName}`);
            input.value = productStock;
            return;
        }
        
        // Get or create row in summary table
        let row = document.getElementById(`summary-row-${productId}`);
        const tbody = document.querySelector('#orderSummary tbody');
        
        if (quantity <= 0) {
            // Remove row if quantity is 0
            if (row) {
                row.remove();
            }
        } else {
            // Calculate total for this item
            const total = quantity * productPrice;
            
            if (!row) {
                // Create new row
                row = document.createElement('tr');
                row.id = `summary-row-${productId}`;
                row.innerHTML = `
                    <td>${productName}</td>
                    <td>${quantity}</td>
                    <td>UGX ${productPrice.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>UGX ${total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                `;
                tbody.appendChild(row);
                
                // Show customer info modal immediately when adding a new product
                if (!hasCustomerInfo()) {
                    const customerInfoModal = new bootstrap.Modal(document.getElementById('customerInfoModal'));
                    customerInfoModal.show();
                }
            } else {
                // Update existing row
                row.innerHTML = `
                    <td>${productName}</td>
                    <td>${quantity}</td>
                    <td>UGX ${productPrice.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>UGX ${total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                `;
            }
        }
        
        // Update grand total
        updateGrandTotal();
        
        // Check if any products are in the cart
        const hasProducts = document.querySelectorAll('#orderSummary tbody tr').length > 0;
        
        // Enable or disable the Complete Sale button
        document.getElementById('completeSaleBtn').disabled = !hasProducts || !hasCustomerInfo();
    }
    
    // Check if customer info is filled
    function hasCustomerInfo() {
        const name = document.getElementById('customer_name').value.trim();
        const phone = document.getElementById('customer_phone').value.trim();
        return name !== '' && phone !== '';
    }
    
    // Save customer info from modal to the form
    function saveCustomerInfo() {
        const modalName = document.getElementById('modal_customer_name').value.trim();
        const modalPhone = document.getElementById('modal_customer_phone').value.trim();
        const modalEmail = document.getElementById('modal_customer_email').value.trim();
        const modalAddress = document.getElementById('modal_customer_address').value.trim();
        
        if (modalName === '' || modalPhone === '') {
            alert('Please enter customer name and phone number.');
            return;
        }
        
        // Transfer values to the main form
        document.getElementById('customer_name').value = modalName;
        document.getElementById('customer_phone').value = modalPhone;
        document.getElementById('customer_email').value = modalEmail;
        document.getElementById('customer_address').value = modalAddress;
        
        // Highlight the customer info section
        document.getElementById('customerInfoCard').classList.add('border-success');
        setTimeout(() => {
            document.getElementById('customerInfoCard').classList.remove('border-success');
        }, 2000);
        
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById('customerInfoModal')).hide();
        
        // Enable the Complete Sale button
        document.getElementById('completeSaleBtn').disabled = false;
    }
    
    // Intercept form submission and submit as JSON instead
    document.getElementById('saleForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission
        
        const hasProducts = document.querySelectorAll('#orderSummary tbody tr').length > 0;
        
        if (!hasProducts) {
            alert('Please add at least one product to the order.');
            return;
        }
        
        if (!hasCustomerInfo()) {
            const customerInfoModal = new bootstrap.Modal(document.getElementById('customerInfoModal'));
            customerInfoModal.show();
            return;
        }
        
        // Prepare customer data
        const customerData = {
            customer_name: document.getElementById('customer_name').value.trim(),
            customer_phone: document.getElementById('customer_phone').value.trim(),
            customer_email: document.getElementById('customer_email').value.trim(),
            customer_address: document.getElementById('customer_address').value.trim()
        };
        
        // Prepare items data
        const itemsData = [];
        const quantityInputs = document.querySelectorAll('input[type="number"]');
        
        quantityInputs.forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                itemsData.push({
                    product_id: parseInt(input.dataset.productId),
                    quantity: quantity,
                    price: parseFloat(input.dataset.productPrice),
                    name: input.dataset.productName,
                    currency: 'UGX'
                });
            }
        });
        
        // Disable submit button and show processing
        const submitButton = document.getElementById('completeSaleBtn');
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';
        
        // Prepare the full payload
        const payload = {
            customer_name: customerData.customer_name,
            customer_phone: customerData.customer_phone,
            customer_email: customerData.customer_email,
            customer_address: customerData.customer_address,
            items: itemsData
        };
        
        // Log the payload for debugging
        console.log("Sending order payload:", payload);
        
        // Submit the data as JSON
        fetch('{{ url_for("in_store_sale") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                console.error("Server error:", response.status, response.statusText);
                throw new Error(`Server responded with status: ${response.status}`);
            }
            // Try to parse JSON, but handle text response as well
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json().catch(error => {
                    console.error("JSON parse error:", error);
                    return response.text().then(text => {
                        console.log("Raw response:", text);
                        throw new Error("Failed to parse JSON response");
                    });
                });
            } else {
                return response.text().then(text => {
                    console.log("Non-JSON response:", text);
                    try {
                        // Try to parse it as JSON anyway
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error("Received non-JSON response: " + text.substring(0, 100));
                    }
                });
            }
        })
        .then(data => {
            if (data.success) {
                console.log("Order success, redirecting to:", data.redirect_url);
                // Redirect to the receipt page
                window.location.href = data.redirect_url;
            } else {
                // Show error message
                alert('Error: ' + (data.error || 'Unknown error'));
                console.error("Order failed:", data);
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        })
        .catch(error => {
            console.error('Error submitting order:', error);
            alert('An error occurred while submitting the order. Please try again.');
            // Re-enable the submit button
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        });
    });
    
    // Calculate and update grand total
    function updateGrandTotal() {
        let grandTotal = 0;
        const rows = document.querySelectorAll('#orderSummary tbody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            // Extract the numeric value from "UGX 12,345.67" format
            const rowTotalText = cells[3].textContent;
            const numericValue = rowTotalText.replace(/[^0-9.]/g, '');
            const rowTotal = parseFloat(numericValue);
            grandTotal += rowTotal;
        });
        
        document.getElementById('grandTotal').textContent = 'UGX ' + grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2});
    }
    
    // Reset the form
    function resetForm() {
        const quantityInputs = document.querySelectorAll('input[type="number"]');
        quantityInputs.forEach(input => {
            input.value = 0;
        });
        
        document.querySelector('#orderSummary tbody').innerHTML = '';
        document.getElementById('grandTotal').textContent = 'UGX 0.00';
        
        // Clear customer info
        document.getElementById('customer_name').value = '';
        document.getElementById('customer_phone').value = '';
        document.getElementById('customer_email').value = '';
        document.getElementById('customer_address').value = '';
        
        // Disable the Complete Sale button
        document.getElementById('completeSaleBtn').disabled = true;
    }
    
    function refreshOrders() {
        // Add visual feedback during refresh
        const refreshBtn = document.getElementById('refreshOrdersBtn');
        const originalText = refreshBtn.innerHTML;
        
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
        
        // Clear the table while refreshing
        document.querySelector('#onlineOrdersTable tbody').innerHTML = '';
        
        // Call API with a timeout to ensure UI feedback
        fetch('/api/pending_orders')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update the display with new data
                updateOrdersDisplay(data);
                
                // Flash feedback for successful refresh
                refreshBtn.innerHTML = '<i class="fas fa-check me-1"></i> Updated!';
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }, 1000);
            })
            .catch(error => {
                console.error('Error refreshing orders:', error);
                // Show error in the button
                refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> Failed!';
                
                // Display error message in table
                const tbody = document.querySelector('#onlineOrdersTable tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to refresh orders. Please try again.
                        </td>
                    </tr>
                `;
                
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }, 2000);
            });
    }
    
    // Separate function to update the orders display
    function updateOrdersDisplay(data) {
        console.log("Received API data:", data); // Debug output
        
        // Check if we have pending_orders in the response
        const pendingOrders = data.pending_orders || [];
        const orderCount = pendingOrders.length;
        
        console.log("Found " + orderCount + " pending orders"); // Debug output
        
        document.getElementById('onlineOrderCount').textContent = orderCount;
        
        if (orderCount > 0) {
            // Ensure the alert is visible
            const alertElement = document.getElementById('onlineOrdersAlert');
            alertElement.classList.add('show');
            alertElement.classList.remove('d-none');
            
            // If there are new orders since last check, show notification
            if (orderCount > lastOrderCount) {
                // Show visual notification
                showOrderNotification();
                
                // Highlight the alert more prominently
                const alert = document.getElementById('onlineOrdersAlert');
                alert.style.backgroundColor = '#fff3cd';
                alert.style.color = '#664d03';
                alert.style.borderColor = '#ffecb5';
                
                // Flash the alert a few times
                let flashCount = 0;
                const flashInterval = setInterval(() => {
                    alert.style.backgroundColor = flashCount % 2 === 0 ? '#ffc107' : '#fff3cd';
                    flashCount++;
                    if (flashCount >= 6) {
                        clearInterval(flashInterval);
                        alert.style.backgroundColor = '#fff3cd';
                    }
                }, 500);
                
                // Show info toast message
                if (typeof bootstrap !== 'undefined' && typeof bootstrap.Toast !== 'undefined') {
                    const toastEl = document.createElement('div');
                    toastEl.className = 'toast position-fixed top-0 end-0 m-3';
                    toastEl.setAttribute('role', 'alert');
                    toastEl.setAttribute('aria-live', 'assertive');
                    toastEl.setAttribute('aria-atomic', 'true');
                    toastEl.innerHTML = `
                        <div class="toast-header bg-primary text-white">
                            <i class="fas fa-bell me-2"></i>
                            <strong class="me-auto">New Online Orders</strong>
                            <small>${new Date().toLocaleTimeString()}</small>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${orderCount - lastOrderCount} new order(s) waiting to be processed.
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#onlineOrdersModal">
                                    View Orders
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(toastEl);
                    const toast = new bootstrap.Toast(toastEl, { autohide: false });
                    toast.show();
                    
                    // Remove toast when closed
                    toastEl.addEventListener('hidden.bs.toast', function() {
                        document.body.removeChild(toastEl);
                    });
                }
            }
            
            // Populate the orders table
            const tbody = document.querySelector('#onlineOrdersTable tbody');
            tbody.innerHTML = '';
            
            pendingOrders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>#${order.id}</td>
                    <td>${order.customer_name}</td>
                    <td>
                        <strong>Phone:</strong> ${order.customer_phone || 'N/A'}<br>
                        <strong>Email:</strong> ${order.customer_email || 'N/A'}
                    </td>
                    <td>${order.customer_address || 'N/A'}</td>
                    <td>${order.order_date}</td>
                    <td>${order.items_count || 1} item(s)</td>
                    <td>UGX ${parseFloat(order.total_amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>
                        <a href="/receipt/${order.id}" class="btn btn-sm btn-info" target="_blank">View</a>
                        <button onclick="markOrderProcessed(${order.id})" class="btn btn-sm btn-success">Process</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // If there's a no orders message, hide it
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            if (noOrdersMessage) {
                noOrdersMessage.classList.add('d-none');
            }
        } else {
            document.getElementById('onlineOrdersAlert').classList.remove('show');
            document.getElementById('onlineOrdersAlert').classList.add('d-none');
            
            // If there's a no orders message, show it
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            if (noOrdersMessage) {
                noOrdersMessage.classList.remove('d-none');
            }
            
            document.querySelector('#onlineOrdersTable tbody').innerHTML = '';
        }
        
        lastOrderCount = orderCount;
    }
    
    function checkOnlineOrders() {
        console.log("Checking for pending orders...");
        fetch('/api/pending_orders')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log("Pending orders API response:", data);
                updateOrdersDisplay(data);
                
                // Double-check display state
                const pendingOrders = data.pending_orders || [];
                if (pendingOrders.length > 0) {
                    console.log("Ensuring alert is visible for " + pendingOrders.length + " orders");
                    const alertElement = document.getElementById('onlineOrdersAlert');
                    if (!alertElement.classList.contains('show') || alertElement.classList.contains('d-none')) {
                        console.log("Alert was hidden, making it visible");
                        alertElement.classList.add('show');
                        alertElement.classList.remove('d-none');
                    }
                }
            })
            .catch(error => {
                console.error('Error checking online orders:', error);
                // Don't show error in the alert area during automatic checks
            });
    }
    
    // Add the markOrderProcessed function to the script section
    function markOrderProcessed(orderId) {
        if (confirm(`Are you sure you want to mark order #${orderId} as processed?`)) {
            fetch(`/mark_order_processed/${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert(data.message);
                    // Refresh the orders list
                    refreshOrders();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error marking order as processed:', error);
                alert('An error occurred while processing the order.');
            });
        }
    }
</script>
{% endblock %} 